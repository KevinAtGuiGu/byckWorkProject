<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div th:fragment="tpl_home">
    <!-- 开始用户注册页面 -->
    <div class="page">
        <div class="weui-form">
            <div class="weui-form__control-area">
                <div class="weui-cells__group weui-cells__group_form">
                    <div class="weui-cells__title">新用户注册</div>
                    <div class="weui-form__control-area">
                        <div class="weui-cells__group weui-cells__group_form">
                            <div class="weui-cells weui-cells_form">
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">手机号</label></div>
                                    <div class="weui-cell__bd">
                                        <input class="weui-input" type="number" oninput="if(value.length>11)value=value.slice(0,11)" pattern="[0-9]*" name='Name' placeholder="请输入手机号"
                                               id="tpl_home_phone"/>
                                    </div>
                                    <div class="weui-cell__ft cha" style="display: none;">
                                        <button class="weui-btn_reset weui-btn_icon">
                                            <i id="showIOSDialog1" class="iconfont icon-icon-cross-empty"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="weui-cell weui-cell_active weui-cell_vcode">
                                    <div class="weui-cell__hd"><label class="weui-label">验证码</label></div>
                                    <div class="weui-cell__bd">
                                        <input autofocus class="weui-input" type="text" name='Name' pattern="[0-9]*"
                                               id="tpl_home_phone_code" placeholder="输入验证码" maxlength="6"/>
                                    </div>
                                    <div class="weui-cell__ft">
                                        <button class="weui-btn weui-btn_default weui-vcode-btn"
                                                id="tpl_home_getCaptchaCode">获取验证码
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label class="weui-label">密码</label></div>
                            <div class="weui-cell__bd">
                                <input type="password" name='Name' id="tpl_home_password1" class="weui-input" placeholder="请输入密码"/>
                            </div>
                            <div class="weui-cell__ft mima" style="display: none;">
                                <button class="weui-btn_reset weui-btn_icon">
                                    <i id="mima" class="iconfont icon-icon-cross-empty"></i>
                                </button>
                            </div>
                        </div>
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label class="weui-label">重复密码</label></div>
                            <div class="weui-cell__bd">
                                <input type="password" id="tpl_home_password2" class="weui-input" name='Name'
                                       placeholder="请输入重复密码"/>
                            </div>
                            <div class="weui-cell__ft chonfumima" style="display: none;">
                                <button class="weui-btn_reset weui-btn_icon">
                                    <i id="chonfumima" class="iconfont icon-icon-cross-empty"></i>
                                </button>
                            </div>
                        </div>
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label class="weui-label">姓名</label></div>
                            <div class="weui-cell__bd">
                                <input id="tpl_home_username" name='Name' class="weui-input" placeholder="填写本人名称" type="text" />
                            </div>
                            <div class="weui-cell__ft xinmin" style="display: none;">
                                <button class="weui-btn_reset weui-btn_icon">
                                    <i id="xinmin" class="iconfont icon-icon-cross-empty"></i>
                                </button>
                            </div>
                        </div>
                        <div class="weui-cell weui-cell_active password">只能输入6-20个字母、数字、下划线密码。</div>
                    </div>
                </div>
            </div>
            <div class="weui-form__tips-area">
                <label id="weuiAgree" for="tpl_home_weuiAgreeCheckbox" class="weui-agree">
                    <input id="tpl_home_weuiAgreeCheckbox" type="checkbox" value="true"
                           class="weui-agree__checkbox"/><span class="weui-agree__text">阅读并同意<a
                        href="javascript:void(0);" id="clause">《相关条款》</a>
                    </span>
                </label>
            </div>
            <div class="weui-form__opr-area">
                <a class="weui-btn weui-btn_primary weui-btn_disabled" href="javascript:;" id="tpl_home_register">确定</a>
            </div>

            <div class="weui-form__extra-area">
                <div class="weui-footer">
                    <p class="weui-footer__links">
                        <a href="login" class="weui-footer__link">已有账号，请登录 ></a>
                    </p>
                    <p class="weui-footer__text">2020-2022 &nbsp; kingTrustCloud</p>
                </div>
            </div>
        </div>
        <!-- 弹窗 -->
        <div class="captcha_dialog" id="tpl_home_captcha" style="display: none;">
            <div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__bd">
                    <a href="javascript:void(0);" title="点击更换验证码">
                        <img th:src="drawCaptcha" id="tpl_home_imgcode" class="imgcode" width="85%"/>
                    </a></br>
                    <input autofocus class="weui-input" type="text" pattern="[0-9]*" id="tpl_home_captcha_input"
                           placeholder="输入验证码" maxlength="6"/>
                </div>
                <div class="weui-dialog__ft">
                    <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="tpl_home_closeCaptchaCode">关闭</a>
                    <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary"
                       id="tpl_home_submitCaptchaCode">确定</a>
                </div>
            </div>
        </div>

        <div id="dialogs">
            <!--BEGIN dialog1-->
            <div class="js_dialog" id="iosDialog1" style="display: none;">
                <div class="weui-mask"></div>
                <div id="js_dialog_1" class="weui-half-screen-dialog">
                    <div class="weui-half-screen-dialog__hd">
                        <div class="weui-half-screen-dialog__hd__side">
                            <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin"></i></button>
                        </div>
                        <div class="weui-half-screen-dialog__hd__main">
                            <strong class="weui-half-screen-dialog__title">紫荆堂，田氏族谱条约</strong>
                        </div>
                    </div>
                    <div class="weui-half-screen-dialog__bd">
                        <br>
                        <br>
                        可放自定义内容
                        <br>
                        <br>
                        <br>
                        <br>
                    </div>
                </div>
            </div>
        </div>

        <div id="js_toast" style="display: none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-icon-success-no-circle weui-icon_toast"></i>
                <p class="weui-toast__content">操作成功！</p>
            </div>
        </div>
    </div>
    <script type="text/javascript" th:inline="javascript">
        $(function () {
            var $dialog1 = $('#js_dialog_1'),
                $iosDialog1 = $('#iosDialog1'),
                isbtn  = false
            var  iswhow = false
            var flag = false;
            var myreg = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
            var page = [[${page}]];
            if(page) {
                // 跳转到指定页面
                window.location.hash = page;
            }
            $("input[name='Name']").live('input propertychange', function()
            {
                if ( $('#tpl_home_phone').val() && $('#tpl_home_phone_code').val() && $('#tpl_home_password1').val() && $('#tpl_home_password2').val() && $('#tpl_home_username').val()) {
                    $('#tpl_home_register').removeClass('weui-btn_disabled');
                    isbtn =true
                } else {
                    $('#tpl_home_register').addClass('weui-btn_disabled');
                    isbtn =false
                }
            });
            $('#tpl_home_username').on('input', function () {
                if ($('#tpl_home_username').val()) {
                     $('.xinmin').show()
                } else {
                    $('.xinmin').hide()
                }
            });
            $('#tpl_home_phone').on('input', function () {
                if ($('#tpl_home_phone').val()) {
                    $('.cha').show()
                } else {
                    $('.cha').hide()
                }
            });
            $('#tpl_home_password1').on('input', function () {
                if ($('#tpl_home_password1').val()) {
                    $('.mima').show()
                } else {
                    $('.mima').hide()
                }
            });
            $('#tpl_home_password2').on('input', function () {
                if ($('#tpl_home_password2').val()) {
                    $('.chonfumima').show()
                } else {
                    $('.chonfumima').hide()
                }
            });
            // 这里是jq的代码
            $('#tpl_home_imgcode').click(function () {
                var url = "drawCaptcha?s=" + Math.random();
                $("#tpl_home_imgcode").attr("src", url);
            });
            $('#tpl_home_getCaptchaCode').on('click', function () {
                var phone=$('#tpl_home_phone').val();
                if(phone == ''){

                    weui.topTips("请填写手机号", 3000);
                    return;
                }else if(phone.length !=11){
                    weui.topTips("不是有效手机号", 3000);
                    return;
                }else if(!myreg.test(phone)){
                    weui.topTips("请输入正确的手机号", 3000);
                    return;
                }else {
                    flag = true
                }
                if(flag && !iswhow){
                    $('#tpl_home_captcha').fadeIn(200);
                    // 刷新一下验证码
                    var url = "drawCaptcha?s=" + Math.random();
                    $("#tpl_home_imgcode").attr("src", url);
                    // 清空验证码框里面的输入值
                    $('#tpl_home_captcha_input').val('');
                }
            });
            $('#xinmin').on('click',function(){
                $(" #tpl_home_username ").val("")
                $('.xinmin').hide()
            });
            $('#showIOSDialog1').on('click',function(){
                $(" input[ type='number' ] ").val("")
                $('.cha').hide()
            });
            $('#chonfumima').on('click',function(){
                $(" #tpl_home_password2 ").val("")
                $('.chonfumima').hide()
            });
            $('#mima').on('click',function(){
                $(" #tpl_home_password1 ").val("")
                $('.mima').hide()
            });
            $('#clause').on('click', function(){
                $iosDialog1.fadeIn(200);
                $dialog1.addClass('weui-half-screen-dialog_show');
            });
            $('#dialogs').on('click', '.weui-mask', function(){
                $('.js_dialog').fadeOut(200);
                $dialog1.removeClass('weui-half-screen-dialog_show');

            });
            $('#dialogs').on('click', '.weui-icon-btn', function(){
                $('.js_dialog').fadeOut(200);
                $dialog1.removeClass('weui-half-screen-dialog_show');

            });

            $("#tpl_home_register").on("click", function () {
                if(!isbtn) return
                var patrn= /^(\w){6,20}$/;
                var phone = $('#tpl_home_phone').val();
                var smsCode = $('#tpl_home_phone_code').val();
                var password1 = $('#tpl_home_password1').val();
                var password2 = $('#tpl_home_password2').val();
                var username = $('#tpl_home_username').val();
                var weuiAgreeCheckbox = $('#tpl_home_weuiAgreeCheckbox').is(':checked');
                if (!phone) {
                    weui.topTips("请填写手机号", 3000);
                    return;
                }
                if (!smsCode) {
                    weui.topTips("请填写验证码", 3000);
                    return;
                }
                if (!password1) {
                    weui.topTips("请填写密码", 3000);
                    return;
                }
                if (password2 != password1) {
                    weui.topTips("确认密码跟密码不一致", 3000);
                    return;
                }
                if (!username) {
                    weui.topTips("请填写用户名", 3000);
                    return;
                }
                if (!weuiAgreeCheckbox) {
                    weui.topTips("请勾选《相关条款》", 3000);
                    return;
                }
                if (!patrn.test(password1)){
                    weui.topTips("请输入6-20个字母、数字、下划线密码", 3000);
                    return;
                }
                var loading1 = weui.loading("加载中..");
                ajaxPost(
                    {
                        type: "POST",
                        url: "register",
                        data: {phone: phone, checkCode: smsCode, password: password1, username: username},
                        success: function (data) {
                            loading1.hide();
                            if (data.statusCode == 200) {
                                iswhow = false
                                $('#tpl_home_getCaptchaCode').text('获取验证码').removeAttr('disabled');
                                $('#tpl_home_getCaptchaCode').css({
                                    background: '#F2F2F2',
                                    color: '#c77e34',
                                });
                                var $toast = $('#js_toast');
                                $toast.fadeIn(100);
                                setTimeout(function () {
                                    $toast.fadeOut(100);
                                    window.location.hash = 'completeInfo';
                                    // window.location.hash = 'searchFamilyBranch';
                                }, 3000);
                            } else {
                                weui.topTips(data.message, 3000);
                            }
                        }
                    });
            });
            // 关闭验证码弹窗
            $('#tpl_home_closeCaptchaCode').on('click',function () {
                var $toast = $('#tpl_home_captcha');
                $toast.fadeOut(100);
            });
            $('#tpl_home_submitCaptchaCode').on('click', function () {
                var code = $('#tpl_home_captcha_input').val();
                var phone = $('#tpl_home_phone').val();
                //var loading1 = weui.loading("加载中..");
                let count = 60;
                if (code == "") {
                    weui.topTips("请填写验证码", 3000);
                    return;
                }
                ajaxPost(
                    {
                        type: "POST",
                        url: "sendSms",
                        data: {kaptchaCode: code, phone: phone,type:"register"},
                        success: function (data) {
                           // loading1.hide();
                            if (data.statusCode == 200) {
                                if(flag && !iswhow){
                                    countDown = setInterval(function()  {
                                        if (count === 0) {
                                            iswhow = false
                                            $('#tpl_home_getCaptchaCode').text('重新发送').removeAttr('disabled');
                                            $('#tpl_home_getCaptchaCode').css({
                                                background: '#F2F2F2',
                                                color: '#c77e34',
                                            });
                                            clearInterval(countDown);
                                        } else {
                                            iswhow = true
                                            $('#tpl_home_getCaptchaCode').attr('disabled', 'true');
                                            $('#tpl_home_getCaptchaCode').css({
                                                background: '#d8d8d8',
                                                color: '#707070',
                                            });
                                            $('#tpl_home_getCaptchaCode').text(count + 's之后重试');
                                        }
                                        count--;
                                    }, 1000);
                                }

                                //$('#tpl_home_phone_code').val(data.data);
                                var $toast = $('#js_toast');
                                $toast.fadeIn(100);
                                setTimeout(function () {
                                    $toast.fadeOut(100);
                                    $("#tpl_home_captcha").fadeOut(200);
                                }, 1000);
                            } else {
                               // $('#tpl_home_imgcode').click(function () {
                                    var url = "drawCaptcha?s=" + Math.random();
                                    $("#tpl_home_imgcode").attr("src", url);
                                    $('#tpl_home_captcha_input').val('');
                               // });
                                weui.topTips(data.message, 1500);
                            }
                        }
                    });
            });
        });
    </script>
    <!-- 开始用户注册页面END -->
</div>
</body>
</html>