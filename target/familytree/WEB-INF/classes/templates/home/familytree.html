<!DOCTYPE html>
<html lang="zh-cmn-Hans" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="tpl_tree">
    <div class="page">
        <div class="page__bd" style="height: 100%;">
            <div class="weui-tab tree">
                <div class="weui-tab__panel tree">
                    <div class="weui-search-bar" id="searchBar">
                        <form class="weui-search-bar__form">
                            <div class="weui-search-bar__box">
                                <i class="weui-icon-search"></i>
                                <input type="search" class="weui-search-bar__input" id="searchInput"
                                       placeholder="输入成员名称" required/>
                                <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                            </div>
                            <label class="weui-search-bar__label" id="searchText">
                                <i class="weui-icon-search"></i>
                                <span>
                                    成员</span>
                            </label>
                        </form>
                        <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
                    </div>
                    <div id="extra-name"></div>
                    <div class="zoom-two">
                        <button id="zoomIn">+</button>
                        <button id="zoomOut">-</button>
                    </div>
                    <div id="jsmind_container"></div>
                </div>
            </div>
        </div>
        <div id="dialogs">
            <div class="js_dialog" id="iosDialog1" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-half-screen-dialog">
                    <div class="weui-half-screen-dialog__hd">
                        <div class="weui-half-screen-dialog__hd__side">
                            <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin"></i></button>
                        </div>
                        <div class="weui-half-screen-dialog__hd__main">
                            <strong class="weui-half-screen-dialog__title">老田</strong>
                        </div>
                    </div>
                    <!--家庭谱-->
                    <div class="family">
                        <ul>
                            <li>
                                <div class="people XY " >
                                    <div class="member">父亲</div>
                                    <div class="one details" data-id="">
                                        <span class="iconfont icon-wode tab-icon"></span>
                                        <span class="name">田大大</span>
                                    </div>
                                    <span class="add addEdit" data-relation="father" style="display: none">+ 添加</span>
                                </div>
                                <span class="member">母亲</span>
                                <div class="list">
                                    <div class="people XX details" data-id="" style="display: none">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name"></span>
                                        </div>
                                    </div>
                                    <span class="add addEdit" data-relation="mather" >+ 添加</span>
                                </div>

                            </li>
                            <li>
                                <div class="member">同胞</div>
                                <div class="list">
                                    <div class="people XY details" style="display: none" data-id="">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name">田大大</span>
                                        </div>
                                    </div>
                                    <div class="people XX details" style="display: none" data-id="">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name">田大大</span>
                                        </div>
                                    </div>
                                    <span class="add addEdit" data-relation="brother" >+ 添加</span>
                                </div>
                            </li>
                            <li>
                                <div class="member">配偶</div>
                                <div class="list">
                                    <div class="people XX details" style="display: none" data-id="">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name">田大大</span>

                                        </div>
                                    </div>
                                    <span class="add addEdit" data-relation="wife" >+ 添加</span>
                                </div>
                            </li>
                            <li>
                                <div class="member">子女</div>
                                <div class="list">
                                    <div class="people XY details" style="display: none" data-id="">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name">田大大</span>

                                        </div>
                                    </div>
                                    <div class="people XX details" style="display: none" data-id="">
                                        <div class="one">
                                            <span class="iconfont icon-wode tab-icon"></span>
                                            <span class="name">田大大</span>
                                        </div>
                                    </div>
                                    <span class="add addEdit"  data-relation="child" >+ 添加</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="people-edit">
                        <div class="details"><a href="home#form details" class="placeholder" data-id="">查看详情</a></div>
                        <div class="delete"><a href="javascript:;" class="placeholder">删除账号</a></div>
                    </div>
                    <!--<div class="weui-half-screen-dialog__bd">-->
                    <!--<div class="weui-grids">-->
                    <!--<a href="javascript:;" class="weui-grid" id="addParent">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">添加父母</p>-->
                    <!--</a>-->
                    <!--<a href="javascript:;" class="weui-grid" id="addMate">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">添加配偶</p>-->
                    <!--</a>-->
                    <!--<a href="javascript:;" class="weui-grid" id="addChildren">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">添加子女</p>-->
                    <!--</a>-->
                    <!--<a href="javascript:;" class="weui-grid" id="addBrotherAndSister">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">添加兄妹</p>-->
                    <!--</a>-->
                    <!--<a href="javascript:;" class="weui-grid" id="edit">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">查看资料</p>-->
                    <!--</a>-->
                    <!--<a href="javascript:;" class="weui-grid" id="delete">-->
                    <!--<div class="weui-grid__icon">-->
                    <!--<img src="./images/icon_tabbar.png" alt="">-->
                    <!--</div>-->
                    <!--<p class="weui-grid__label">删除</p>-->
                    <!--</a>-->
                    <!--</div>-->
                    <!--</div>-->
                </div>
            </div>
        </div>
        <div id="txtToast" style="display: none;opacity: 0;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-txtToast">
                <p class="weui-toast__content">没有该权限</p>
            </div>
        </div>
        <div class="noBody" style="display: none">
            <a href="javascript:;" class="weui-btn weui-btn_primary">添加成员</a>
        </div>

        <div class="SearchBar searchbar" style="display: none">
            <div class="weui-cells searchbar-result" id="searchResult">
                
                <div class="weui-cell weui-cell_active weui-cell_access">
                    <div class="weui-cell__bd weui-cell_primary">
                        <p>关键词搜索结果
                            <span class="right"></span>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript">
        // import 'homeTree.js';
        //加载公用的js
        new_element=document.createElement("script");
        new_element.setAttribute("type","text/javascript");
        new_element.setAttribute("src","assets/js/homeTree.js");
        document.body.appendChild(new_element);


        var urlData = JSON.parse('{"' + location.search.replace("?","").replace(/&/g, '","').replace(/=/g, '":"') + '"}');
        // var urlData = JSON.parse(sessionStorage.getItem("someId"))
        console.log(urlData)
        var _jm = null;
        var memberId = 0;
        var familyBranchId = 0;
        // 家族成员原始列表
        var sourceData = [];


        var isMe = [[${session.user.memberBasicInfoEntity.memberId}]];
        var isAdmin = [[${session.user.userRole == '分支管理员'}]];
        var isSuperAdmin = [[${session.user.userRole == '超级管理员'}]];

        window.onload=function(){

            // var callBack="Hello World";
            // b(callBack);
            $(function () {
                //弹窗
                $('#dialogs').on('click', '.weui-mask', function () {
                    $(this).parents('.js_dialog').fadeOut(200);
                    $('#cloneiosDialog1').removeClass('weui-half-screen-dialog_show');
                    // $('#js_dialog_1').removeClass('weui-half-screen-dialog_show');
                });

                $(".weui-icon-close-thin").on('click', function () {
                    $('#cloneiosDialog1').fadeOut(200);
                    $('#cloneiosDialog1').find('.weui-half-screen-dialog').removeClass('weui-half-screen-dialog_show');
                });

                //树的高度
                $("#jsmind_container").height($(window).height() - 85);

                //搜索
                var $searchBar = $('#searchBar'),
                    $searchResult = $('#searchResult'),
                    $searchText = $('#searchText'),
                    $searchInput = $('#searchInput'),
                    $searchClear = $('#searchClear'),
                    $searchCancel = $('#searchCancel');

                function hideSearchResult(){
                    $searchResult.hide();
                    $searchInput.val('');
                }
                function cancelSearch(){
                    hideSearchResult();
                    $searchBar.removeClass('weui-search-bar_focusing');
                    $searchText.show();
                }

                $searchText.on('click', function(){
                    $searchBar.addClass('weui-search-bar_focusing');
                    $searchInput.focus();
                    $('.SearchBar').css('display','block')
                });
                $searchInput
                    .on('blur', function () {
                        if(!this.value.length) cancelSearch();
                    })
                    .on('input', function(){
                        if(this.value.length) {
                            $searchResult.show();
                        } else {
                            $searchResult.hide();
                        }
                    })
                ;
                $searchClear.on('click', function(){
                    hideSearchResult();
                    $searchInput.focus();

                });
                $searchCancel.on('click', function(){
                    cancelSearch();
                    $searchInput.blur();
                    $('.SearchBar').css('display','none')
                });
                $(".weui-grid").on("click", function () {
                    if ($(this).attr("id") == "addParent") {
                        location.href = "form?memberId=" + memberId + "&op=0";
                    } else if ($(this).attr("id") == "addMate") {
                        location.href = "form?memberId=" + memberId + "&op=1";
                    } else if ($(this).attr("id") == "addChildren") {
                        location.href = "form?memberId=" + memberId + "&op=2";
                    } else if ($(this).attr("id") == "addBrotherAndSister") {
                        location.href = "form?memberId=" + memberId + "&op=3";
                    } else if ($(this).attr("id") == "showDetail") {
                        //
                    } else if ($(this).attr("id") == "edit") {
                        location.href = "form?memberId=" + memberId + "&op=4";
                    } else if ($(this).attr("id") == "delete") {
                        location.href = "form?memberId=" + memberId + "&op=5";
                    }
                });


                $('#searchInput').live('input propertychange', function()
                {
                    //获取input 元素,并实时监听用户输入
                    inputcheng =  $('#searchInput').val();
                    show()
                });
                function show(){
                    var arr = []
                    var  showlist = "",
                        zhi
                    if(inputcheng == ""){
                        // arr = list
                        $('#searchResult').empty()
                        $('#searchResult').html(
                            '<div class="weui-cell weui-cell_active weui-cell_access">\n' +
                            '                    <div class="weui-cell__bd weui-cell_primary">\n' +
                            '                        <p>关键词搜索结果</p>\n' +
                            '                    </div>\n' +
                            '                </div>')
                    }else if(inputcheng){
                        console.log(sourceData ,"++++++")
                        for (var i = 0; i < sourceData.length; i++) {
                            zhi = sourceData[i].userName
                            if (zhi.indexOf(inputcheng) != -1) {
                                //因为indexof找不到的时候是一律为-1，所以直接判断是否为-1，不是就弹出这个值
                                arr.push(sourceData[i]); //将值放入
                            }
                        }
                        searchMember(arr)

                    }


                    // $('#checkBoxsBranch').empty()
                    // $("#checkBoxsBranch").append(
                    //     showlist
                    // );

                }

                $('.noBody a').on('click',function () {

                    var someId = {}
                    someId['familyBranchId']=urlData.familyBranchId
                    someId['familyId']=urlData.familyId
                    someId['body']='none'

                    window.sessionStorage.setItem('someId',JSON.stringify(someId));
                    window.location.hash = 'form'

                    // window.location.href = 'my?familyBranchId='+ urlData.familyBranchId + '&familyId='+ urlData.familyId + '&body=none#form'
                })
                ajax()
            });
        }

        function ajax() {
            var jsMindData = [];
            var loading = weui.loading('数据加载中...');
            ajaxPost(
                {
                    type: "GET",
                    url: "member/getMembersByFamilyBranchId",
                    data:{familyBranchId:urlData.familyBranchId},
                    success: function (data) {
                        if (data.statusCode == 200) {
                            loading.hide();
                            sourceData=data.data;
                            extraName(data.extra)
                            if(!sourceData || sourceData.length == 0){
                                $('.noBody').css('display','block')
                            }else {
                                $('.noBody').css('display','none')
                            }
                            jsMindData = formatData(data.data);
                            load_jsmind(jsMindData);
                            // searchMember(sourceData);
                            if(sourceData && sourceData.length>0) {
                                familyBranchId = sourceData[0].familyBranchId
                            }

                        } else {
                            loading.hide();
                            weui.topTips(data.message, 3000);
                        }
                    }
                });
        }


    </script>
</div>
</body>
</html>