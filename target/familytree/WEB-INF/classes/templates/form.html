<!DOCTYPE html>
<html lang="zh-cmn-Hans" xmlns:th="http://www.thymeleaf.org">
<head>
    <base th:href="${#request.getContextPath()}+'/'">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>编辑</title>
    <link rel="stylesheet" href="assets/css/weui.min.css"/>
    <link rel="stylesheet" href="assets/css/familytree.css"/>
</head>
<body>
<div class="container" id="container">
    <form id="editForm">
        <input type="hidden" name="parentMemberId" value="0">
        <input type="hidden" name="memberId" value="0">
        <input type="hidden" name="mateId">
        <input type="hidden" name="groupId">
        <div class="page slideIn">
            <div class="weui-form">
                <div class="weui-form__control-area">
                    <div class="weui-cells__group weui-cells__group_form">
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell weui-cell_uploader" id="uploader">
                                <div class="weui-cell__hd"><label class="weui-label">头像</label></div>
                                <div class="weui-cell__bd" >
                                    <ul class="weui-uploader__files" >
                                    </ul>
                                    <input type="hidden" name="headThumb">
                                    <div class="weui-uploader__input-box">
                                        <input name="uploaderInput" id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"/>
                                    </div>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">姓名</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="userName" class="weui-input" placeholder="填写本人姓名" required emptyTips="请输入姓名" notMatchTips="请输入正确的姓名" />
                                </div>
                            </div>
                            <div class="weui-cell weui-cell_active weui-cell_access weui-cell_select weui-cell_select-after">
                                <div class="weui-cell__hd"><label class="weui-label">性别</label></div>
                                <div class="weui-cell__bd" id="showPickerGender">
                                    <label id="genderLabel">男</label>
                                    <input type="hidden" name="genderId" value="0">
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">联系电话</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="mobileNo" class="weui-input" placeholder="填写绑定的电话号码" type="number" pattern="[0-9]*" />
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">家谱名</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="familyName" class="weui-input" placeholder="家谱中的名字"/>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">曾用名</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="otherName" class="weui-input" placeholder="曾经用过的名字"/>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">身份证</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="idCardNo" class="weui-input" placeholder="填写本人身份证号码"/>
                                </div>
                            </div>
                            <div class="weui-cell weui-cell_access" id="showDatePickerBirthday">
                                <div class="weui-cell__bd">出生日期</div>
                                <label id="birthdayLabel"></label>
                                <div class="weui-cell__ft"></div>
                                <input type="hidden" name="birthday">
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">出生地点</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="birthPlace" class="weui-input" placeholder="填写本人出生地点"/>
                                </div>
                            </div>
                            <div class="weui-cell weui-cell_switch">
                                <div class="weui-cell__bd">是否离世</div>
                                <div class="weui-cell__ft">
                                    <input id="isDeadChk" class="weui-switch" type="checkbox"/>
                                    <input name="isDead"  type="hidden" value="0"/>
                                </div>
                            </div>
                        </div>
                        <div id="dead_area" style="display: none">
                            <div class="weui-cell weui-cell_access" id="showDatePickerDeadDate">
                                <div class="weui-cell__bd">死亡日期</div>
                                <label id="deadDateLabel"></label>
                                <div class="weui-cell__ft"></div>
                                <input type="hidden" name="deadDate">
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">死亡地点</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="deadPlace" class="weui-input" placeholder="填写死亡地点"/>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">埋葬地点</label></div>
                                <div class="weui-cell__bd weui-flex">
                                    <input name="tombPlace" class="weui-input" placeholder="填写埋葬地点"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <div class="weui-form__opr-area">
                <a class="weui-btn weui-btn_primary" href="javascript:" id="submit">确定</a>
                <a href="javascript:;" class="weui-btn weui-btn_default" id="cancel">取消</a>
            </div>
        </div>
    </form>
    <div class="weui-gallery" id="gallery">
        <span class="weui-gallery__img" id="galleryImg"></span>
        <div class="weui-gallery__opr">
            <a href="javascript:" class="weui-gallery__del">
                <i class="weui-icon-delete weui-icon_gallery-delete"></i>
            </a>
        </div>
    </div>
</div>
<script src="assets/js/zepto.min.js"></script>
<script type="text/javascript" src="assets/js/jweixin-1.0.0.js"></script>
<script src="assets/js/weui.min.js"></script>
<script src="assets/js/familytree.js"></script>
<script type="text/javascript">
    $(function(){
        loadData(function(){
            regEvent();
        });
    });
    function loadData(regEv){
        var memberId=getURLVar("memberId");
        var op=getURLVar("op");
        var loading1 = weui.loading("加载中..");
        ajaxPost(
            {
                type:"GET",
                url: "member/getMember/"+memberId,
                success: function (data) {
                    if(data.statusCode==200){
                        var parentMemberId=data.data.parentMemberId;
                        var mateId=data.data.mateId;
                        loading1.hide();
                        //$("inpuit[name='memberId']").val(memberId);
                        if(op==0){//添加父母
                            ajaxPost(
                                {
                                    type:"GET",
                                    url: "member/getMember/"+parentMemberId,
                                    success: function (data0) {
                                        loading1.hide();
                                        if(data0.statusCode==200){
                                            $("input[name='parentMemberId']").val(data0.data.parentMemberId);//
                                            $("input[name='mateId']").val(data0.data.memberId);
                                        }else{
                                            weui.topTips(data0.message, 3000);
                                        }
                                    }
                                });
                        }else if(op==1){//添加fu夫妻
                            $("input[name='parentMemberId']").val(parentMemberId);
                            if(!isNullOrEmpty(mateId) && mateId>0){//如果已经存在第一任夫君，则将挂在第一夫君上面（第一个人，也可能是女人）
                                $("input[name='mateId']").val(mateId);
                            }else{
                                $("input[name='mateId']").val(data.data.memberId);
                            }

                        }else if(op==2){//添加子女
                            if(!isNullOrEmpty(mateId) && mateId>0){//如果已经存在夫君，则将子女挂在夫君上面（第一个人，也可能是女人）
                                $("input[name='parentMemberId']").val(mateId);
                            }else{
                                $("input[name='parentMemberId']").val(memberId);
                            }
                        }else if(op==3){//添加兄妹
                            $("input[name='parentMemberId']").val(parentMemberId);
                        }else if(op==4){//编辑
                            loadForm($("#editForm"),data.data);
                            $("#genderLabel").html(data.data.genderId==0?"男":"女");
                            if(!isNullOrEmpty(data.data.headThumb)){
                                $(".weui-uploader__input-box").hide();
                                $(".weui-uploader__files").append('<li class="weui-uploader__file" data-id="1" style="background-image: url('+data.data.headThumb+')"></li>');
                            }
                        }
                        regEv();
                    }else{
                        loading1.hide();
                        weui.topTips(data.message, 3000);
                    }
                }
            });
    }
    function regEvent(){
        $("#cancel").on("click",function(){
            $(".page").removeClass("slideIn").addClass("slideOut");
            setInterval(
                function(){
                    history.go(-1);
                }
                ,300)
        });
        $('#showDatePickerBirthday').on('click', function () {
            weui.datePicker({
                start: 1990,
                end: new Date().getFullYear(),
                onChange: function (result) {
                    $("#birthdayLabel").html(result[0].value+'-'+result[1].value+'-'+result[2].value);
                    $("input[name='birthday']").val(result[0].value+'-'+result[1].value+'-'+result[2].value);
                },
                onConfirm: function (result) {
                    $("#birthdayLabel").html(result[0].value+'-'+result[1].value+'-'+result[2].value);
                    $("input[name='birthday']").val(result[0].value+'-'+result[1].value+'-'+result[2].value);
                },
                title: '请选择日期'
            });
        });
        $('#showDatePickerDeadDate').on('click', function () {
            weui.datePicker({
                start: 1990,
                end: new Date().getFullYear(),
                onChange: function (result) {
                    $("#deadDateLabel").html(result[0].value+'-'+result[1].value+'-'+result[2].value);
                    $("input[name='dead_date']").val(result[0].value+'-'+result[1].value+'-'+result[2].value);
                },
                onConfirm: function (result) {
                    $("#deadDateLabel").html(result[0].value+'-'+result[1].value+'-'+result[2].value);
                    $("input[name='dead_date']").val(result[0].value+'-'+result[1].value+'-'+result[2].value);
                },
                title: '请选择去世日期'
            });
        });
        $("#isDeadChk").on("change",function(){
            if($(this).is(":checked")){
                $("#dead_area").show();
                $("input[name='isDead']").val(1);
            }else{
                $("#dead_area").hide();
                $("input[name='isDead']").val(0);
            }

        });
        $('#showPickerGender').on('click', function () {
            weui.picker([{
                label: '男',
                value: 0
            }, {
                label: '女',
                value: 1
            }], {
                onChange: function (result) {
                    //console.log(result);
                    $("#genderLabel").html(result[0].label);
                    $("input[name='genderId']").val(result[0].value);
                },
                onConfirm: function (result) {
                    //console.log(result);
                    $("input[name='genderId']").val(result[0].value);
                },
                title: '请选择性别'
            });
        });
        var $gallery = $("#gallery"),
            $galleryImg = $("#galleryImg"),
            $uploaderFiles = $(".weui-uploader__files")
        ;
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });
        $(".weui-icon_gallery-delete").on("click",function(){
            $uploaderFiles.find("li").remove();
            $(".weui-uploader__input-box").show();
        });
        weui.uploader('#uploader', {
            url: 'member/upload',
            auto: true,
            type: 'base64',
            fileVal: 'fileVal',
            compress: {
                width: 100,
                height: 100,
                quality: .8
            },
            onBeforeQueued: function(files) {
                // `this` 是轮询到的文件, `files` 是所有文件
                if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
                    weui.alert('请上传图片');
                    return false; // 阻止文件添加
                }
                if(this.size > 10 * 1024 * 1024){
                    weui.alert('请上传不超过10M的图片');
                    return false;
                }
                if (files.length > 1) { // 防止一下子选择过多文件
                    weui.alert('最多只能上传1张图片，请重新选择');
                    return false;
                }
            },
            onQueued: function(){
                $(".weui-uploader__input-box").hide();
            },
            onBeforeSend: function(data, headers){

            },
            onProgress: function(procent){
            },
            onSuccess: function (ret) {
                $("[name='headThumb']").val(this.base64);
            },
            onError: function(err){
            }
        });
        $("#submit").on("click",function(){
            //weui.topTips('请填写正确的字段');
            weui.form.validate('#editForm', function (error) {
                if (!error) {
                    var loading = weui.loading('提交中...');
                    ajaxPost(
                        {
                            url: "member/saveMember",
                            data: $("#editForm").serialize() ,
                            success: function (data) {
                                if(data.statusCode==200){
                                    setTimeout(function () {
                                        loading.hide();
                                        weui.toast('操作成功', {
                                            duration: 3000,
                                            className: 'custom-classname',
                                            callback: function(){
                                                location.href="familytree";
                                            }
                                        });
                                    }, 1500);
                                }else{
                                    loading.hide();
                                    weui.topTips(data.message, 3000);
                                }
                            }
                        });
                }
            }, {
                regexp: {
                    IDNUM: /(?:^\d{15}$)|(?:^\d{18}$)|^\d{17}[\dXx]$/,
                    VCODE: /^.{4}$/
                }
            });
        });

    }
</script>
</body>
</html>
